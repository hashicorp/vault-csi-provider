---
# Test application that mounts secrets from Vault
apiVersion: v1
kind: Pod
metadata:
  name: test-app
  namespace: csi
spec:
  serviceAccountName: test-app
  containers:
  - name: app
    image: busybox:latest
    command:
    - /bin/sh
    - -c
    - |
      echo "==> Checking mounted secrets..."
      ls -la /mnt/secrets-store/
      echo ""
      echo "==> Secret contents:"
      cat /mnt/secrets-store/* 2>/dev/null || echo "No secrets found"
      echo ""
      echo "==> Keeping pod alive for testing..."
      sleep 3600
    volumeMounts:
    - name: secrets-store
      mountPath: "/mnt/secrets-store"
      readOnly: true
  volumes:
  - name: secrets-store
    csi:
      driver: secrets-store.csi.k8s.io
      readOnly: true
      volumeAttributes:
        secretProviderClass: "vault-test-secrets"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: test-app
  namespace: csi
---
# SecretProviderClass - tells the CSI driver how to fetch secrets from Vault
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: vault-test-secrets
  namespace: csi
spec:
  provider: vault
  parameters:
    vaultAddress: "http://vault:8200"
    roleName: "test-role"
    objects: |
      - objectName: "secret1"
        secretPath: "secret/data/test"
        secretKey: "password"

